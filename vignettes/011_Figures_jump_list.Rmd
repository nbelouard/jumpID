---
title: '#1B Creating the figures associated with the jump analysis'
author:
- Nadege Belouard^[iEco lab at Temple University, Ecobio lab at the University of
  Rennes, nadege.belouard@gmail.com]
- Isabella G. Smith^[iEco lab at Temple University]
date: "`r Sys.Date()`"
output:
  pdf_document:
    toc: true
    toc_depth: '3'
  html_document:
    toc: true
    toc_float: true
    toc_depth: 3
params:
  display: false
  run: true
  loadfiles: false
  savefiles: true
editor_options:
  chunk_output_type: console
---

# Aim and setup

This vignette computes all the figures included in the manuscript that is associated with the `jumpID` package. This vignette requires loading data frames generated in the first vignette of this package.  

```{r load packages, messages = F, warning = F, include = FALSE}

library(dplyr)
library(magrittr)
library(ggplot2)
library(cowplot)
library(jumpID)
```

Load files generated in the previous vignette  

```{r load datasets}
slf <- read.csv(file.path(here::here(), "data", "lyde_data_v2", "lyde.csv"), h=T)
grid_data <- read.csv(file.path(here::here(), "exported-data", "grid_data.csv"), h=T)
centroid <- data.frame(longitude_rounded = -75.675340, latitude_rounded = 40.415240)

Jumps <- read.csv(file.path(here::here(), "exported-data", "jumps.csv"))
Jump_clusters <- read.csv(file.path(here::here(), "exported-data", "jump_clusters.csv"))
Thresholds <- read.csv(file.path(here::here(), "exported-data", "thresholds.csv"))
diffusion <- read.csv(file.path(here::here(), "exported-data", "diffusion.csv"))
secDiffusion <- read.csv(here::here("exported-data", "secdiffusion.csv"))
```

```{r create an object for the US background map, messages = FALSE, warnings = FALSE, echo = FALSE}

# get a simple feature objects for states 
states <- sf::st_as_sf(maps::map("state", plot = FALSE, fill = TRUE)) %>%
  sf::st_transform(crs = 4326)
```



# Figure 2: Faceted jump map, barplot & distance

## 2A: jump map 
Map the position of jumps and identify jump clusters per year  

```{r jump map, fig.width = 8, fig.height = 6, echo = FALSE}

map_rarefied <- ggplot(data = states) +
  geom_sf(data = states, fill = "white") +
  # positive points
  geom_point(data = grid_data %>% filter(established == TRUE), 
             aes(x = longitude, y = latitude), col = "lightgrey") +
  # introduction point
  annotate("point", x = -75.675340, y = 40.415240, 
           col = "black", shape = 4, size = 3) +
  # all jumps
  geom_point(data = Jumps,
             aes(x = longitude, y = latitude, col = as.factor(year), 
             shape = "All jumps"), size = 3) +
  # jump clusters
  geom_point(data = Jump_clusters, 
             aes(x = longitude, y = latitude, shape = "Rarefied jumps"), 
             col = "black", fill = "white", size = 1) +
  
  scale_color_manual(name = "Year",
                     values = c("#d53e4f", "#fc8d59", "#f4c957", "#94e65f", "#59a68e", "#27679e"),
                     labels = c("2017", "2018", "2019", "2020", "2021", "2022")) +
  scale_shape_manual(name = "Jumps", 
                     values = c("All jumps" = 19, "Rarefied jumps" = 21)) +
  coord_sf(xlim = c(-86, -70), ylim = c(36, 44), expand = FALSE) +
  labs(x = "Longitude", y = "Latitude") +
  theme(panel.background = element_rect(fill = "white"))

#| fig.alt: >
#|   Map with dispersal jumps colored by year, and rarefied jumps
map_rarefied
```

## 2B: number of jumps per year bar plot
Count how many jumps there are per year  

```{r number of jumps per year, include = FALSE}

# add the type of data to each dataset
Jump_clusters %<>% mutate(Type = "Rarefied jumps")
Jumps %<>% mutate(Type = "All jumps")

# count the number of clusters per year
Clusters_year <- Jump_clusters %>% 
  group_by(year, Type) %>% 
  summarise(n = n()) 

# count the total number of jumps per year
Jumps_year <- Jumps %>% 
  group_by(year, Type) %>% 
  summarise(n = n()) %>% 
  left_join(Clusters_year, by = "year") %>% 
  mutate(n = n.x - n.y) %>% 
  rename(Type = Type.x)

# bind the two tables
Jumps_total <- bind_rows(Clusters_year, Jumps_year %>% select(year, Type, n))
```

```{r number of jumps bar plot, fig.height = 2.5, fig.width = 4, echo = FALSE}

jumps_plot <- ggplot() +
  geom_bar(data = Jumps_total, 
           aes(x = year, y = n, fill = as.factor(year), col = as.factor(year), 
               group = Type, alpha = Type), 
           stat = "identity", lwd = .25, show.legend = F) +
  scale_fill_manual(values = c("#d53e4f", "#fc8d59", "#f4c957", "#94e65f", "#59a68e", "#27679e")) +
  scale_color_manual(values = c("#d53e4f", "#fc8d59", "#f4c957", "#94e65f", "#59a68e", "#27679e")) +
  scale_alpha_manual(values = c(1, 0)) +
  xlab("Year") + ylab("Number of jumps") +
  theme_classic() +
  scale_x_continuous(breaks = seq(2017, 2022, by = 1)) +
  theme(text = element_text(size = 10))

#| fig.alt: >
#|   Barplot with the number of jump clusters and jumps, colored by year
jumps_plot
```

## 2C: distance of jumps box plot
calculate the distance between the invasion front and jumps every year

```{r dist to front per year, fig.height = 2.5, fig.width = 4, echo = FALSE}

# 1. select all diffusion points for the rarefied jump dataset
diffusion_rarefied <- setdiff(grid_data %>% filter(established == T), 
                        Jump_clusters %>% select(year, latitude, longitude, established, DistToIntro)) %>% # remove jump clusters from grid data
  setdiff(secDiffusion) # remove secondary diffusion too

#2. calculate jump distance for each jump
for (jump in 1:length(Jump_clusters$DistToIntro)){ #for each jump
  y = Jump_clusters[jump,] %>% pull(year)
  diffusion_y <- diffusion %>% filter(year == y)
  pairwise_dist <- geosphere::distGeo(diffusion_y[,c('longitude','latitude')], Jump_clusters[jump,c('longitude','latitude')])/1000
  Jump_clusters$DistToFront[jump] = min(pairwise_dist) 
} 


MeanDist_jump <- ggplot() +
  geom_boxplot(data = Jump_clusters, show.legend = F,
               aes(x = year,
                 y = DistToFront, 
                   col = as.factor(year)
                 ),
               alpha = 0, outlier.alpha = 0.7) +
  
  scale_color_manual(name = "Year", values = c("#d53e4f", "#fc8d59", "#f4c957", "#94e65f", "#59a68e", "#27679e")) +
  scale_x_continuous(breaks = seq(2017, 2022, by = 1)) +
  labs(x = "Year",
    y = "Distance from core invasion (km)") +
  theme_classic() 

#| fig.alt: >
#|   Boxplot with the distance of jump clusters from the invasion front colored by year
MeanDist_jump
```

## 2D Evolution of jump distances

```{r test evolution jump distances, echo = FALSE, fig.height = 2.5, fig.width = 4}

Distrib_jumpDist <- ggplot(Jump_clusters, aes(x = DistToFront)) +
  geom_histogram(aes(fill = as.factor(-year)), binwidth = 10, show.legend = F) +
  scale_fill_manual(name = "Year", values = c("#27679e", "#59a68e", "#94e65f", "#f4c957", "#fc8d59", "#d53e4f")) +
  theme_classic() +
  labs(x = "Distance from core invasion (km)",
       y = "Count of jump locations")

#| fig.alt: >
#|   Histogram of the jump distances colored by year
Distrib_jumpDist
```

Linear model for statistical test
```{r lm jumpDist}
# generate model
model <- lm(log(DistToFront) ~ year, data = Jump_clusters)
# look at residuals
hist(model$residuals)
# look at results
summary(model)
```

## Assemble figure 2ABCD
```{r figure 1 complete, echo = FALSE, fig.height = 10, fig.width = 10}

fig2 <- ggdraw() +
  draw_plot(map_rarefied, x = 0, y = .33, width = 1, height = .66) +
  draw_plot(jumps_plot, 0, 0, .33, .33) +
  draw_plot(MeanDist_jump, .33, 0, .33, .33) +
  draw_plot(Distrib_jumpDist, .66, 0, .33, .33) +
  draw_plot_label(c("(a)", "(b)", "(c)", "(d)"), c(0, 0, 0.33, 0.66), c(1, 0.36, 0.36, 0.36), size = 15) +
  theme(plot.background = element_rect(fill="#FFFFFF", color = NA))

#| fig.alt: >
#|   Figure assembling the previous figures A, B, C, D.
fig2

ggsave(file.path(here::here(), "figures", "2. jump_description.jpg"), 
       fig2, height = 10, width = 10)

```





# Figure 3: Invasion radius

To estimate the spread of the SLF, we extract for each year the radius of the invasion in each sector. We can look at how the radius of the invasion increases over time, when differentiating diffusive spread and jump dispersal.   

```{r radius box plot, fig.height = 6, fig.width = 10, include = FALSE}

sectors_used = 16

# calculate max radius for diffusion only
thresholdMaxSector <- data.frame(NULL)

# take the threshold data (most extreme diffusion points)
for (y in unique(Thresholds$year)){ # for each year,
  # distribute data in sectors
  thresholdSectors <- jumpID::attribute_sectors(Thresholds %>% 
                                                  select(year, latitude, longitude, DistToIntro) %>% 
                                                  filter(year %in% c(2014:y)), 
                                                nb_sectors = sectors_used, 
                                                centroid = c(-75.67534, 40.41524))

  # for each sector, take the maximum radius
  thresholdMaxSectorYear <- thresholdSectors %>% 
    group_by(sectors_nb) %>%
    summarise(maxDistToIntro = max(DistToIntro)) %>% 
    mutate(year = y)
  
  # add it to the table
  thresholdMaxSector <- rbind(thresholdMaxSector, thresholdMaxSectorYear)
}

# do the same thing for jumps
# calculate max radius for jumps
jumpMaxSector = data.frame(NULL)

for (y in unique(Jumps$year)){
  jumpSectors <- jumpID::attribute_sectors(Jumps %>% 
                                             select(year, latitude, longitude, DistToIntro) %>% 
                                             filter(year %in% c(2014:y)), 
                                           nb_sectors = sectors_used, 
                                           centroid = c(-75.67534, 40.41524))

  jumpsMaxSectorYear <- jumpSectors %>% 
    group_by(sectors_nb) %>%
    summarise(maxDistToIntro = max(DistToIntro)) %>% 
    mutate(year = y)
  
  jumpMaxSector <- rbind(jumpMaxSector, jumpsMaxSectorYear)
}

# we combine thresholds and jumps to get the "all spread" dataset
allMaxSector <- bind_rows(thresholdMaxSector, jumpMaxSector) %>% 
  group_by(year, sectors_nb) %>% 
  summarise(maxDistToIntro = max(maxDistToIntro))

# combine all spread and invasion front data
radiusData <- bind_rows(allMaxSector %>% 
                          mutate(Type = "All spread"),
                        thresholdMaxSector %>% mutate(Type = "Invasion front"))

# plot results
invasionRadius <- ggplot(data = radiusData, 
                         aes(x = as.factor(year), y = maxDistToIntro, 
                             fill = Type)) +
  geom_boxplot() +
  scale_fill_manual(name = "Type", values = c("All spread" = "white", 
                                              "Invasion front" = "gray60")) +
  theme_classic() +
  labs(x = "Year", y = "refDist") +
  theme(legend.title = element_text(size = 20),
      legend.text = element_text(size = 16),
      legend.key.size = unit(2, "lines"),
      axis.title = element_text(size = 18),
      axis.text = element_text(size = 12))

#| fig.alt: >
#|   Boxplot showing the yearly invasion radius when considering diffusion only or all spread
invasionRadius

ggsave(file.path(here::here(), "figures", "3. invasionRadius.jpeg"), 
       invasionRadius, height = 6, width = 10)
```


Test the difference in invasion radius between spread types
```{r test difference in radius}
# generate model
model <- lm(log(maxDistToIntro) ~ year*Type, data = radiusData)
# look at residuals
hist(model$residuals, breaks = 30)
# look at results
anova(model)
``` 

Calculate the yearly increase in invasion radius
```{r mean radius, include = FALSE} 

meanRadius <- radiusData %>% group_by(Type, year) %>% 
  summarise(mean = mean(maxDistToIntro)) %>% 
  ungroup()
```

```{r yearly increase in invasion radius}
# All spread:
meanRadius %>% filter(Type == "All spread") %>% 
  mutate(radiusIncrease = c(NA, diff(mean))) %>% 
  summarise(mean = mean(radiusIncrease, na.rm = T),
            sd = sd(radiusIncrease, na.rm = T))

# Invasion front:
meanRadius %>% filter(Type == "Invasion front") %>% 
  mutate(radiusIncrease = c(NA, diff(mean))) %>% 
  summarise(mean = mean(radiusIncrease, na.rm=T),
            sd = sd(radiusIncrease, na.rm = T))        
```



# Supplementary figures

## Figure S1: Map all points
Facet A: Overview of all SLF surveys   

```{r map data, fig.width = 6, fig.height = 5, echo = FALSE}

# plot US map
mapUS <- ggplot(data = states) +
  geom_point(data = grid_data %>% filter(established == FALSE),
             aes(x = longitude, y = latitude), col = "gray", size = 1) +
  geom_point(data = grid_data %>% filter(established == TRUE),
             aes(x = longitude, y = latitude), col = "black", size = 1) +
  geom_sf(alpha = 0) +
  labs(x = "Longitude", y = "Latitude") +
  theme_classic() +
  theme(legend.position = "bottom", legend.key = element_rect(fill = "white", colour = NA)) 

#| fig.alt: >
#|   Map showing all SLF surveys done in the US
mapUS

# save it
ggsave(file.path(here::here(), "figures", "S1A. points_all.jpg"), 
       mapUS, width = 6, height = 6)
```

Facet B: Zoomed map on established SLF  

```{r zoomed map S1, fig.width = 6, fig.height = 5, echo = FALSE}

# create a variable for a meaningful legend
grid_data %<>% mutate(SLF = ifelse(established == T, "Present", "Absent"))

# plot zoomed map
zoomedMap <- ggplot(data = states) +
  geom_point(data = grid_data %>% filter(established == FALSE),
             aes(x = longitude, y = latitude), col = "gray", size = 1) +
  geom_point(data = grid_data %>% filter(established == TRUE),
             aes(x = longitude, y = latitude), col = "black", size = 1) +
  geom_sf(alpha = 0) +
  labs(x = "Longitude", y = "Latitude") +
  coord_sf(xlim = c(-86, -70), ylim = c(36, 44)) +
  theme_classic() +
  theme(legend.position="bottom", legend.key = element_rect(fill = "white", colour = NA)) 

#| fig.alt: >
#|   Map zoomed-in on the eastern US to show positive and negative SLF surveys
zoomedMap

# save it
ggsave(file.path(here::here(), "figures", "S1B. zoomed_points.jpg"), 
       zoomedMap, width = 6, height = 6)
```



## Figure S2: Visualizing Jumps, Thresholds, and SecDiff
Visualize all results, faceted by year  
```{r facet all results per year, fig.height = 12, fig.width = 20, echo = FALSE}

# Make a single object for the map
jumps_wrapper_map <- dplyr::bind_rows(grid_data %>% filter(established == F) %>%
                                        dplyr::mutate(Type = "SLF not established"),
                                      diffusion %>%
                                        dplyr::mutate(Type = "Diffusion"),
                       Jumps %>% dplyr::mutate(Type = "Jump"),
                       secDiffusion %>% dplyr::mutate(Type = "Secondary diffusion"))

facetedResults <- ggplot(data = states) +
  geom_point(data = jumps_wrapper_map, aes(x = longitude, y = latitude, col = Type)) +
  geom_sf(data = states, alpha = 0) +
  facet_wrap(~year) +
  theme(legend.position = "bottom") +
  theme_classic() +
  scale_color_manual(values = c("blue", "green", "orange", "gray90")) +
  xlab("Longitude") + ylab("Latitude") + labs(col = "Identification") +
  coord_sf(xlim = c(-82, -72), ylim = c(38, 43), expand = FALSE) +
  theme(legend.position = "right", text = element_text(size = 10),
      panel.background = element_rect(fill = "white"),
      legend.key = element_rect(fill = "white"),
      legend.title = element_text(size = 20),
      legend.text = element_text(size = 16),
      legend.key.size = unit(2, "lines"),
      axis.title = element_text(size = 18),
      axis.text = element_text(size = 12))

#| fig.alt: >
#|   Output of the jumpID workflow: maps of diffusion, jumps and secondary diffusion identified per year, faceted per year
facetedResults

ggsave(file.path(here::here(), "figures", "S2. faceted_results.jpeg"), 
       facetedResults, height = 12, width = 20)


```


# Figure S3: secondary diffusion
## S3A: Map
Map the points identified as secondary diffusion around dispersal jumps.  
```{r secondary diffusion map, fig.height = 8, fig.width = 15, echo = FALSE}

secDiff_map <- ggplot() +
  geom_point(data = grid_data %>% filter(established == TRUE), 
             aes(x = longitude, y = latitude), 
             col = "lightgrey") +
  geom_point(data = secDiffusion %>% arrange(desc(year)),  
             aes(x = longitude, y = latitude,
                 col = as.factor(year)), 
             stroke = 2, size = 4) +
  geom_point(data = Jump_clusters %>% arrange(desc(year)),  
             aes(x = longitude, y = latitude, col = as.factor(year), fill = as.factor(year)),
             color = "black",
              shape = 21, 
             stroke = 0.5, size = 3.5) +
  scale_color_manual(values = c( "#f4c957", "#94e65f", "#59a68e", "#27679e")) +
  scale_fill_manual(values = c( "#d53e4f", "#fc8d59", "#f4c957", "#94e65f", "#59a68e", "#27679e")) +
  labs(x = "Longitude", y = "Latitude") +
  theme(legend.position = "right", text = element_text(size = 10),
        panel.background = element_rect(fill = "white"),
        legend.key = element_rect(fill = "white"),
        legend.title = element_text(size = 20),
        legend.text = element_text(size = 16),
        legend.key.size = unit(2, "lines"),
        axis.title = element_text(size = 18),
        axis.text = element_text(size = 12)) +
    geom_sf(data = states, alpha = 0) +
    coord_sf(xlim = c(-85.25, -71), ylim = c(36.5, 43)) +
  guides(colour = guide_legend(paste0("Secondary", "\n", "Diffusion")), 
         fill = guide_legend("Rarefied jumps"))

#| fig.alt: >
#|   Map showing the location of secondary diffusion around dispersal jumps, colored by year
secDiff_map
```


## S3B: Secondary diffusion Bar Plot
Count how many jumps were followed by secondary diffusion  
```{r calculating jumps followed by secDiff, include = FALSE}

# select jumps for which we have data for year n+1
Jumps_2021 <- Jumps %>% filter(year %in% c(2014:2021)) %>% 
  mutate(secDiff = NA)

# determine if they are followed by secondary diffusion, or enveloped by diffusion
for (jump in 1:length(Jumps_2021$DistToIntro)){ # for each jump
  # is this jump within 1 km of any diffusion point the year after? ie. enveloped by diffusion
  testDiff <- diffusion %>% filter(year == Jumps_2021$year[jump]+1)
  pairwise_dist <- geosphere::distGeo(testDiff[,c('longitude','latitude')], Jumps_2021[jump,c('longitude','latitude')])/1000
  
  if (min(pairwise_dist) < 1){ Jumps_2021$secDiff[jump] = "enveloped" 
  } else {
  # is there secondary diffusion within 15 km of this jump the year after?
  # calculate pairwise distance with secDiff the year after
    testSecDiff <- secDiffusion %>% filter(year == Jumps_2021$year[jump]+1)
    if (dim(testSecDiff)[1] > 0){
      pairwise_dist <- geosphere::distGeo(testSecDiff[,c('longitude','latitude')], Jumps_2021[jump,c('longitude','latitude')])/1000
      Jumps_2021$secDiff[jump] = ifelse(min(pairwise_dist) < 15, "yes", "no")
    } else { Jumps_2021$secDiff[jump] = "no" } # if there is no secDiff
  }
}

# count the number of jumps in each category (yes, no, enveloped)
Jumps_secDiff <- Jumps_2021 %>%
  group_by(year, secDiff) %>%
  summarise(count = n()) %>%
  ungroup()

# order this factor
Jumps_secDiff$secDiff <- factor(Jumps_secDiff$secDiff, 
                                levels = c("enveloped", "no", "yes"))
```

```{r bar plot secDiff, fig.height = 5, fig.width = 8, echo = FALSE}
#Bar Plot
Jumps_secDiff_plot <- ggplot() +
  geom_bar(data = Jumps_secDiff,
           aes(x = as.factor(year),
               y = count,
               group = secDiff,
               fill = as.factor(year),
               col = as.factor(year), 
               alpha = secDiff),
           lwd = .25,
           stat = "identity") +
  scale_fill_manual(values = c("#d53e4f", "#fc8d59", "#f4c957", "#94e65f", 
                               "#59a68e", "#27679e"), guide = "none") +
  scale_color_manual(values = c("#d53e4f", "#fc8d59", "#f4c957", "#94e65f", 
                                "#59a68e", "#27679e"), guide = "none") +
  scale_alpha_manual(values = c(0.3, 0, 1)) +
  theme_classic() +
  xlab("Year of Jump") +
  ylab("Number of Jumps") +
  guides(alpha = guide_legend(
    paste0("Sec. diffusion after jump"),
    override.aes = list(fill = "black", color = "black", linetype = 1, shape = 21))) +
  theme(legend.title = element_text(size = 20),
        legend.text = element_text(size = 16),
        legend.key.size = unit(2, "lines"),
        axis.title = element_text(size = 18),
        axis.text = element_text(size = 12))

#| fig.alt: >
#|   Barplot with the number of jumps followed by secondary diffusion or enveloped, colored by year
Jumps_secDiff_plot
```

## Assemble figure S3AB
```{r combine secDiff graphs, fig.height = 13, fig.width = 13, echo = FALSE}
secDiff_graphs_combined <- cowplot::ggdraw() +
  cowplot::draw_plot(secDiff_map, 0, .33, 1, 0.66) +
  cowplot::draw_plot(Jumps_secDiff_plot, 0, 0, 1, 0.33) +
  cowplot::draw_plot_label(c("(a)", "(b)"), c(0.06, 0.06), c(0.90, 0.33), size = 25) 

#| fig.alt: >
#|   Figure combining previous figures A and B
secDiff_graphs_combined

ggsave(file.path(here::here(), "figures", "S3. secDiff_combined.jpeg"),
       secDiff_graphs_combined, height = 13, width = 13)

```


## Figure S4: Sampling effort
Show the evolution of the sampling effort and jump occurrences over time  
```{r figure sampling effort, fig.width = 7, fig.height = 5, echo = FALSE}

slf %<>% filter(!is.na(lyde_established))

surveys <- as.data.frame(table(slf$bio_year)) %>% 
  mutate(Type = "Surveys") %>% 
  rename(year = Var1, n = Freq)

points <- as.data.frame(table(grid_data$year)) %>% 
  mutate(Type = "Points") %>% 
  rename(year = Var1, n = Freq)

positives <- grid_data %>% filter(established == T)
positive_points <- as.data.frame(table(positives$year)) %>% 
  mutate(Type = "Positive points") %>% 
  rename(year = Var1, n = Freq)

jumps <- Jumps %>% 
  count(year) %>% 
  mutate(Type = "Dispersal jumps")

clusters <- Jump_clusters %>% 
  count(year) %>% 
  mutate(Type = "Jump clusters")

effort <- rbind(surveys, points, positive_points, jumps, clusters)
effort$Type <- factor(effort$Type, 
                      levels = c("Surveys", "Points", "Positive points", 
                                 "Dispersal jumps", "Jump clusters"))

effort_plot <- ggplot() +
  geom_point(data = effort, aes(x = year, y = n, shape = Type), 
             size = 3) +
  theme_classic() +
  scale_y_log10() + 
  xlab("Year") + ylab("Number of surveys") +
  guides(shape = guide_legend("Survey type"))
  
#| fig.alt: >
#|   Plot showing the evolution of the number of SLF surveys per year
effort_plot

ggsave(file.path(here::here(), "figures", "S4. number of surveys.jpg"), 
       effort_plot, width = 7, height = 5)

```

-- end of vignette --
